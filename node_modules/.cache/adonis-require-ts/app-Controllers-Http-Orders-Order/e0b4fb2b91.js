"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const Order_1 = global[Symbol.for('ioc.use')]("App/Validators/Order");
const Models_1 = global[Symbol.for('ioc.use')]("App/Models");
const Database_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Lucid/Database"));
require("dotenv/config");
const mailersend_1 = require("mailersend");
class ProductController {
    async store({ request }) {
        const { title, name, obs, products, email } = await request.validate(Order_1.StoreValidator);
        const sentFrom = new mailersend_1.Sender("felipe@athstocktake.com", "Felipe");
        const mailerSend = new mailersend_1.MailerSend({
            apiKey: 'mlsn.b5c0d3fa7855ed1cd1bbd8e74a037330e397c01194026ee722d5822ea6e1a088',
        });
        const recipients = [new mailersend_1.Recipient(email, "Your Client")];
        const personalization = [
            {
                email: email,
                data: {
                    title: title,
                    products: products,
                    account_name: name,
                    support_email: obs
                },
            }
        ];
        const emailParams = new mailersend_1.EmailParams()
            .setFrom(sentFrom)
            .setTo(recipients)
            .setSubject("Subject")
            .setTemplateId('z3m5jgr96vmgdpyo')
            .setPersonalization(personalization);
        try {
            await mailerSend.email.send(emailParams);
            return { message: 'Email enviado com sucesso.' };
        }
        catch (error) {
            console.log(error);
        }
    }
    async log({ request, params }) {
        const payload = request.all();
        console.log(payload);
        await Database_1.default.insertQuery().table('logs').insert({ payload: JSON.stringify(payload) });
        return { message: 'Log criado com sucesso.' };
    }
    async index({ auth }) {
        try {
            const orders = await Database_1.default.query()
                .from('orders')
                .select('*')
                .where('user_id', auth.user.id)
                .where('status', true);
            for (let order in orders) {
                orders[order].total = 0;
                const products = await Database_1.default.query()
                    .from('order_products')
                    .sum('price as total')
                    .where('order_id', orders[order].id);
                orders[order].total = products[0].total;
            }
            return orders;
        }
        catch (error) {
            console.log(error);
        }
    }
    async show({ params, bouncer }) {
        let order = (await Models_1.Order.findByOrFail('id', params.id));
        await bouncer.authorize('isAuthorized', order.userId);
        return order;
    }
    async update({ request, response, bouncer }) {
        const { id, name, place, obs, status } = await request.validate(Order_1.UpdateValidator);
        await Database_1.default.transaction(async (trx) => {
            const order = await Models_1.Order.findByOrFail('id', id);
            order.useTransaction(trx);
            await order.load('user');
            await bouncer.authorize('isAuthorized', order.userId);
            order.merge({ name, place, obs, status });
            await order.save();
            return response.ok({ message: 'Comanda alterada com sucesso.' });
        });
    }
    async destroy({ request, response, bouncer }) {
        const { id } = await request.validate(Order_1.DestroyValidator);
        const order = await Models_1.Order.findByOrFail('id', id);
        await order.load('user');
        await bouncer.authorize('isAuthorized', order.userId);
        order.status = false;
        await order.save();
        return response.ok({ message: 'Comanda finalizada com sucesso.' });
    }
}
exports.default = ProductController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT3JkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJPcmRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLHNFQUF3RjtBQUN4Riw2REFBa0M7QUFDbEMsMkZBQWlEO0FBRWpELHlCQUF1QjtBQUN2QiwyQ0FBd0U7QUFFeEUsTUFBcUIsaUJBQWlCO0lBQzdCLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxPQUFPLEVBQXVCO1FBQ2pELE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSxPQUFPLENBQUMsUUFBUSxDQUFDLHNCQUFjLENBQUMsQ0FBQTtRQUNwRixNQUFNLFFBQVEsR0FBRyxJQUFJLG1CQUFNLENBQUMseUJBQXlCLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDakUsTUFBTSxVQUFVLEdBQUcsSUFBSSx1QkFBVSxDQUFDO1lBQ2hDLE1BQU0sRUFBRSx1RUFBdUU7U0FDaEYsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxVQUFVLEdBQUcsQ0FBQyxJQUFJLHNCQUFTLENBQUMsS0FBSyxFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUM7UUFDekQsTUFBTSxlQUFlLEdBQUc7WUFDdEI7Z0JBQ0UsS0FBSyxFQUFFLEtBQUs7Z0JBQ1osSUFBSSxFQUFFO29CQUNKLEtBQUssRUFBRSxLQUFLO29CQUNaLFFBQVEsRUFBRSxRQUFRO29CQUNsQixZQUFZLEVBQUUsSUFBSTtvQkFDbEIsYUFBYSxFQUFFLEdBQUc7aUJBQ25CO2FBQ0Y7U0FDRixDQUFDO1FBQ0YsTUFBTSxXQUFXLEdBQUcsSUFBSSx3QkFBVyxFQUFFO2FBQ3BDLE9BQU8sQ0FBQyxRQUFRLENBQUM7YUFDakIsS0FBSyxDQUFDLFVBQVUsQ0FBQzthQUNqQixVQUFVLENBQUMsU0FBUyxDQUFDO2FBQ3JCLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQzthQUNqQyxrQkFBa0IsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUNyQyxJ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QUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUN4QixNQUFNLE9BQU8sQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUNyRCxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQTtZQUN6QyxNQUFNLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQTtZQUNsQixPQUFPLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUUsK0JBQStCLEVBQUUsQ0FBQyxDQUFBO1FBQ2xFLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVNLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBdUI7UUFDdEUsTUFBTSxFQUFFLEVBQUUsRUFBRSxHQUFHLE1BQU0sT0FBTyxDQUFDLFFBQVEsQ0FBQyx3QkFBZ0IsQ0FBQyxDQUFBO1FBQ3ZELE1BQU0sS0FBSyxHQUFHLE1BQU0sY0FBSyxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUE7UUFDaEQsTUFBTSxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ3hCLE1BQU0sT0FBTyxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ3JELEtBQUssQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFBO1FBQ3BCLE1BQU0sS0FBSyxDQUFDLElBQUksRUFBRSxDQUFBO1FBQ2xCLE9BQU8sUUFBUSxDQUFDLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxpQ0FBaUMsRUFBRSxDQUFDLENBQUE7SUFDcEUsQ0FBQztDQUdGO0FBL0dELG9DQStHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDb250ZXh0Q29udHJhY3QgfSBmcm9tICdAaW9jOkFkb25pcy9Db3JlL0h0dHBDb250ZXh0J1xuaW1wb3J0IHsgU3RvcmVWYWxpZGF0b3IsIFVwZGF0ZVZhbGlkYXRvciwgRGVzdHJveVZhbGlkYXRvciB9IGZyb20gJ0FwcC9WYWxpZGF0b3JzL09yZGVyJ1xuaW1wb3J0IHsgT3JkZXIgfSBmcm9tICdBcHAvTW9kZWxzJ1xuaW1wb3J0IERhdGFiYXNlIGZyb20gJ0Bpb2M6QWRvbmlzL0x1Y2lkL0RhdGFiYXNlJ1xuXG5pbXBvcnQgJ2RvdGVudi9jb25maWcnO1xuaW1wb3J0IHsgTWFpbGVyU2VuZCwgRW1haWxQYXJhbXMsIFNlbmRlciwgUmVjaXBpZW50IH0gZnJvbSBcIm1haWxlcnNlbmRcIjtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUHJvZHVjdENvbnRyb2xsZXIge1xuICBwdWJsaWMgYXN5bmMgc3RvcmUoeyByZXF1ZXN0IH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICBjb25zdCB7IHRpdGxlLCBuYW1lLCBvYnMsIHByb2R1Y3RzLCBlbWFpbCB9ID0gYXdhaXQgcmVxdWVzdC52YWxpZGF0ZShTdG9yZVZhbGlkYXRvcilcbiAgICBjb25zdCBzZW50RnJvbSA9IG5ldyBTZW5kZXIoXCJmZWxpcGVAYXRoc3RvY2t0YWtlLmNvbVwiLCBcIkZlbGlwZVwiKTtcbiAgICBjb25zdCBtYWlsZXJTZW5kID0gbmV3IE1haWxlclNlbmQoe1xuICAgICAgYXBpS2V5OiAnbWxzbi5iNWMwZDNmYTc4NTVlZDFjZDFiYmQ4ZTc0YTAzNzMzMGUzOTdjMDExOTQwMjZlZTcyMmQ1ODIyZWE2ZTFhMDg4JyxcbiAgICB9KTtcbiAgICBjb25zdCByZWNpcGllbnRzID0gW25ldyBSZWNpcGllbnQoZW1haWwsIFwiWW91ciBDbGllbnRcIildO1xuICAgIGNvbnN0IHBlcnNvbmFsaXphdGlvbiA9IFtcbiAgICAgIHtcbiAgICAgICAgZW1haWw6IGVtYWlsLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdGl0bGU6IHRpdGxlLFxuICAgICAgICAgIHByb2R1Y3RzOiBwcm9kdWN0cyxcbiAgICAgICAgICBhY2NvdW50X25hbWU6IG5hbWUsXG4gICAgICAgICAgc3VwcG9ydF9lbWFpbDogb2JzXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgXTtcbiAgICBjb25zdCBlbWFpbFBhcmFtcyA9IG5ldyBFbWFpbFBhcmFtcygpXG4gICAgLnNldEZyb20oc2VudEZyb20pXG4gICAgLnNldFRvKHJlY2lwaWVudHMpXG4gICAgLnNldFN1YmplY3QoXCJTdWJqZWN0XCIpXG4gICAgLnNldFRlbXBsYXRlSWQoJ3ozbTVqZ3I5NnZtZ2RweW8nKVxuICAgIC5zZXRQZXJzb25hbGl6YXRpb24ocGVyc29uYWxpemF0aW9uKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgbWFpbGVyU2VuZC5lbWFpbC5zZW5kKGVtYWlsUGFyYW1zKTtcbiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICdFbWFpbCBlbnZpYWRvIGNvbSBzdWNlc3NvLicgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmxvZyhlcnJvcilcbiAgICB9XG4gIH1cblxuICAvLyBjcmVhdGUgYSBsb2dcbiAgcHVibGljIGFzeW5jIGxvZyh7IHJlcXVlc3QscGFyYW1zIH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICBjb25zdCBwYXlsb2FkID0gcmVxdWVzdC5hbGwoKVxuICAgIGNvbnNvbGUubG9nKHBheWxvYWQpXG4gICAgYXdhaXQgRGF0YWJhc2UuaW5zZXJ0UXVlcnkoKS50YWJsZSgnbG9ncycpLmluc2VydCh7IHBheWxvYWQ6IEpTT04uc3RyaW5naWZ5KHBheWxvYWQpIH0pXG4gICAgcmV0dXJuIHsgbWVzc2FnZTogJ0xvZyBjcmlhZG8gY29tIHN1Y2Vzc28uJyB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgaW5kZXgoeyBhdXRoIH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgb3JkZXJzID0gYXdhaXQgRGF0YWJhc2UucXVlcnkoKVxuICAgICAgICAuZnJvbSgnb3JkZXJzJylcbiAgICAgICAgLnNlbGVjdCgnKicpXG4gICAgICAgIC53aGVyZSgndXNlcl9pZCcsIGF1dGgudXNlciEuaWQpXG4gICAgICAgIC53aGVyZSgnc3RhdHVzJywgdHJ1ZSlcbiAgICAgIGZvciAobGV0IG9yZGVyIGluIG9yZGVycykge1xuICAgICAgICBvcmRlcnNbb3JkZXJdLnRvdGFsID0gMFxuICAgICAgICBjb25zdCBwcm9kdWN0cyA9IGF3YWl0IERhdGFiYXNlLnF1ZXJ5KClcbiAgICAgICAgICAuZnJvbSgnb3JkZXJfcHJvZHVjdHMnKVxuICAgICAgICAgIC5zdW0oJ3ByaWNlIGFzIHRvdGFsJylcbiAgICAgICAgICAud2hlcmUoJ29yZGVyX2lkJywgb3JkZXJzW29yZGVyXS5pZClcbiAgICAgICAgb3JkZXJzW29yZGVyXS50b3RhbCA9IHByb2R1Y3RzWzBdLnRvdGFsXG4gICAgICB9XG5cbiAgICAgIC8vIG9yZGVycy5tYXAoYXN5bmMgKG9yZGVyKSA9PiB7XG4gICAgICAvLyAgIG9yZGVyLnRvdGFsID0gMFxuICAgICAgLy8gICBjb25zdCBwcm9kdWN0cyA9IGF3YWl0IERhdGFiYXNlLnF1ZXJ5KClcbiAgICAgIC8vICAgICAuZnJvbSgnb3JkZXJfcHJvZHVjdHMnKVxuICAgICAgLy8gICAgIC5zdW0oJ3ByaWNlIGFzIHRvdGFsJylcbiAgICAgIC8vICAgICAud2hlcmUoJ29yZGVyX2lkJywgb3JkZXIuaWQpXG4gICAgICAvLyAgIGlmIChwcm9kdWN0c1swXS50b3RhbCAhPT0gbnVsbCkge1xuICAgICAgLy8gICAgIG9yZGVyLnRvdGFsID0gb3JkZXIudG90YWwgKyBwcm9kdWN0c1swXS50b3RhbFxuICAgICAgLy8gICAgIGNvbnNvbGUubG9nKG9yZGVyKVxuICAgICAgLy8gICB9XG4gICAgICAvLyB9KVxuICAgICAgcmV0dXJuIG9yZGVyc1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmxvZyhlcnJvcilcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2hvdyh7IHBhcmFtcywgYm91bmNlciB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgbGV0IG9yZGVyID0gKGF3YWl0IE9yZGVyLmZpbmRCeU9yRmFpbCgnaWQnLCBwYXJhbXMuaWQpKSBhcyBhbnlcbiAgICBhd2FpdCBib3VuY2VyLmF1dGhvcml6ZSgnaXNBdXRob3JpemVkJywgb3JkZXIudXNlcklkKVxuICAgIC8vIG9yZGVyLnRvdGFsID0gMFxuICAgIC8vIGlmIChvcmRlci5wcm9kdWN0cyAhPT0gbnVsbCkge1xuICAgIC8vICAgY29uc3QgaXRlbSA9IE9iamVjdC52YWx1ZXMoSlNPTi5wYXJzZShvcmRlci5wcm9kdWN0cykpIGFzIGFueVxuICAgIC8vICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpdGVtLmxlbmd0aDsgaSsrKSB7XG4gICAgLy8gICAgIG9yZGVyLnRvdGFsID0gb3JkZXIudG90YWwgKyBpdGVtW2ldLnByaWNlICogaXRlbVtpXS5hbW91bnRcbiAgICAvLyAgIH1cbiAgICAvLyB9XG4gICAgcmV0dXJuIG9yZGVyXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlKHsgcmVxdWVzdCwgcmVzcG9uc2UsIGJvdW5jZXIgfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuICAgIGNvbnN0IHsgaWQsIG5hbWUsIHBsYWNlLCBvYnMsIHN0YXR1cyB9ID0gYXdhaXQgcmVxdWVzdC52YWxpZGF0ZShVcGRhdGVWYWxpZGF0b3IpXG4gICAgYXdhaXQgRGF0YWJhc2UudHJhbnNhY3Rpb24oYXN5bmMgKHRyeCkgPT4ge1xuICAgICAgY29uc3Qgb3JkZXIgPSBhd2FpdCBPcmRlci5maW5kQnlPckZhaWwoJ2lkJywgaWQpXG4gICAgICBvcmRlci51c2VUcmFuc2FjdGlvbih0cngpXG4gICAgICBhd2FpdCBvcmRlci5sb2FkKCd1c2VyJylcbiAgICAgIGF3YWl0IGJvdW5jZXIuYXV0aG9yaXplKCdpc0F1dGhvcml6ZWQnLCBvcmRlci51c2VySWQpXG4gICAgICBvcmRlci5tZXJnZSh7IG5hbWUsIHBsYWNlLCBvYnMsIHN0YXR1cyB9KVxuICAgICAgYXdhaXQgb3JkZXIuc2F2ZSgpXG4gICAgICByZXR1cm4gcmVzcG9uc2Uub2soeyBtZXNzYWdlOiAnQ29tYW5kYSBhbHRlcmFkYSBjb20gc3VjZXNzby4nIH0pXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZXN0cm95KHsgcmVxdWVzdCwgcmVzcG9uc2UsIGJvdW5jZXIgfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuICAgIGNvbnN0IHsgaWQgfSA9IGF3YWl0IHJlcXVlc3QudmFsaWRhdGUoRGVzdHJveVZhbGlkYXRvcilcbiAgICBjb25zdCBvcmRlciA9IGF3YWl0IE9yZGVyLmZpbmRCeU9yRmFpbCgnaWQnLCBpZClcbiAgICBhd2FpdCBvcmRlci5sb2FkKCd1c2VyJylcbiAgICBhd2FpdCBib3VuY2VyLmF1dGhvcml6ZSgnaXNBdXRob3JpemVkJywgb3JkZXIudXNlcklkKVxuICAgIG9yZGVyLnN0YXR1cyA9IGZhbHNlXG4gICAgYXdhaXQgb3JkZXIuc2F2ZSgpXG4gICAgcmV0dXJuIHJlc3BvbnNlLm9rKHsgbWVzc2FnZTogJ0NvbWFuZGEgZmluYWxpemFkYSBjb20gc3VjZXNzby4nIH0pXG4gIH1cbiAgXG5cbn1cbiJdfQ==