"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const Product_1 = global[Symbol.for('ioc.use')]("App/Validators/Product");
const Models_1 = global[Symbol.for('ioc.use')]("App/Models");
const Database_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Lucid/Database"));
class ProductController {
    async store({ request, response }) {
        const product = new Models_1.Product();
        const { code, suplier, description, class: productClass, price, min, max, place, } = await request.validate(Product_1.StoreValidator);
        product.code = code;
        product.suplier = suplier;
        product.description = description;
        product.class = productClass;
        product.storage = 0;
        product.price = price;
        product.min = min;
        product.max = max;
        product.place = place;
        await product.save();
        response.send({ message: 'Produto cadastrado com sucesso.' });
    }
    async index({ request }) {
        console.log(request.headers['x-forwarded-for']);
        const products = await Database_1.default.query().from('products').select('*').orderBy('id', 'asc');
        products.forEach((product) => {
            if (product.storage > product.max * 0.2) {
                product.status = 'Good';
            }
            else {
                product.status = 'Bad';
            }
        });
        return products;
    }
    async show({ params }) {
        const products = await Database_1.default.query().from('products').select('*').where('code', params.name);
        return products;
    }
    async productsByCategory({ params }) {
        const products = await Database_1.default.query().from('products').select('*').orderBy(params.category);
        products.forEach((product) => {
            if (product.storage > product.max * 0.2) {
                product.status = 'Good';
            }
            else {
                product.status = 'Bad';
            }
        });
        return products;
    }
    async update({ request, response }) {
        const { id, code, suplier, description, class: productClass, price, storage, min, max, place, } = await request.validate(Product_1.UpdateValidator);
        await Database_1.default.transaction(async (trx) => {
            const product = await Models_1.Product.findByOrFail('id', id);
            product.useTransaction(trx);
            product.merge({
                code,
                suplier,
                description,
                class: productClass,
                price,
                storage,
                min,
                max,
                place,
            });
            await product.save();
            return response.ok({ message: 'Produto alterado com sucesso.' });
        });
    }
}
exports.default = ProductController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUHJvZHVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlByb2R1Y3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFDQSwwRUFBd0U7QUFDeEUsNkRBQW9DO0FBQ3BDLDJGQUFpRDtBQUlqRCxNQUFxQixpQkFBaUI7SUFDN0IsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQXVCO1FBQzNELE1BQU0sT0FBTyxHQUFHLElBQUksZ0JBQU8sRUFBRSxDQUFBO1FBQzdCLE1BQU0sRUFDSixJQUFJLEVBQ0osT0FBTyxFQUNQLFdBQVcsRUFDWCxLQUFLLEVBQUUsWUFBWSxFQUNuQixLQUFLLEVBQ0wsR0FBRyxFQUNILEdBQUcsRUFDSCxLQUFLLEdBQ04sR0FBRyxNQUFNLE9BQU8sQ0FBQyxRQUFRLENBQUMsd0JBQWMsQ0FBQyxDQUFBO1FBQzFDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFBO1FBQ25CLE9BQU8sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFBO1FBQ3pCLE9BQU8sQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFBO1FBQ2pDLE9BQU8sQ0FBQyxLQUFLLEdBQUcsWUFBWSxDQUFBO1FBQzVCLE9BQU8sQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFBO1FBQ25CLE9BQU8sQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO1FBQ3JCLE9BQU8sQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFBO1FBQ2pCLE9BQU8sQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFBO1FBQ2pCLE9BQU8sQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO1FBQ3JCLE1BQU0sT0FBTyxDQUFDLElBQUksRUFBRSxDQUFBO1FBQ3BCLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsaUNBQWlDLEVBQUUsQ0FBQyxDQUFBO0lBQy9ELENBQUM7SUFJTSxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsT0FBTyxFQUFFO1FBQzVCLE9BQU8sQ0FBQyxHQUFH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ImltcG9ydCB7IEh0dHBDb250ZXh0Q29udHJhY3QgfSBmcm9tICdAaW9jOkFkb25pcy9Db3JlL0h0dHBDb250ZXh0J1xuaW1wb3J0IHsgU3RvcmVWYWxpZGF0b3IsIFVwZGF0ZVZhbGlkYXRvciB9IGZyb20gJ0FwcC9WYWxpZGF0b3JzL1Byb2R1Y3QnXG5pbXBvcnQgeyBQcm9kdWN0IH0gZnJvbSAnQXBwL01vZGVscydcbmltcG9ydCBEYXRhYmFzZSBmcm9tICdAaW9jOkFkb25pcy9MdWNpZC9EYXRhYmFzZSdcblxuLy90ZXN0ZVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQcm9kdWN0Q29udHJvbGxlciB7XG4gIHB1YmxpYyBhc3luYyBzdG9yZSh7IHJlcXVlc3QsIHJlc3BvbnNlIH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICBjb25zdCBwcm9kdWN0ID0gbmV3IFByb2R1Y3QoKVxuICAgIGNvbnN0IHtcbiAgICAgIGNvZGUsXG4gICAgICBzdXBsaWVyLFxuICAgICAgZGVzY3JpcHRpb24sXG4gICAgICBjbGFzczogcHJvZHVjdENsYXNzLFxuICAgICAgcHJpY2UsXG4gICAgICBtaW4sXG4gICAgICBtYXgsXG4gICAgICBwbGFjZSxcbiAgICB9ID0gYXdhaXQgcmVxdWVzdC52YWxpZGF0ZShTdG9yZVZhbGlkYXRvcilcbiAgICBwcm9kdWN0LmNvZGUgPSBjb2RlXG4gICAgcHJvZHVjdC5zdXBsaWVyID0gc3VwbGllclxuICAgIHByb2R1Y3QuZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvblxuICAgIHByb2R1Y3QuY2xhc3MgPSBwcm9kdWN0Q2xhc3NcbiAgICBwcm9kdWN0LnN0b3JhZ2UgPSAwXG4gICAgcHJvZHVjdC5wcmljZSA9IHByaWNlXG4gICAgcHJvZHVjdC5taW4gPSBtaW5cbiAgICBwcm9kdWN0Lm1heCA9IG1heFxuICAgIHByb2R1Y3QucGxhY2UgPSBwbGFjZVxuICAgIGF3YWl0IHByb2R1Y3Quc2F2ZSgpXG4gICAgcmVzcG9uc2Uuc2VuZCh7IG1lc3NhZ2U6ICdQcm9kdXRvIGNhZGFzdHJhZG8gY29tIHN1Y2Vzc28uJyB9KVxuICB9XG5cbiAgLy8yMCVcblxuICBwdWJsaWMgYXN5bmMgaW5kZXgoeyByZXF1ZXN0IH0pIHtcbiAgICBjb25zb2xlLmxvZyhyZXF1ZXN0LmhlYWRlcnNbJ3gtZm9yd2FyZGVkLWZvciddKVxuICAgIGNvbnN0IHByb2R1Y3RzID0gYXdhaXQgRGF0YWJhc2UucXVlcnkoKS5mcm9tKCdwcm9kdWN0cycpLnNlbGVjdCgnKicpLm9yZGVyQnkoJ2lkJywgJ2FzYycpXG4gICAgcHJvZHVjdHMuZm9yRWFjaCgocHJvZHVjdCkgPT4ge1xuICAgICAgaWYgKHByb2R1Y3Quc3RvcmFnZSA+IHByb2R1Y3QubWF4ICogMC4yKSB7XG4gICAgICAgIHByb2R1Y3Quc3RhdHVzID0gJ0dvb2QnXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwcm9kdWN0LnN0YXR1cyA9ICdCYWQnXG4gICAgICB9XG4gICAgfSlcbiAgICByZXR1cm4gcHJvZHVjdHNcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzaG93KHsgcGFyYW1zIH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICBjb25zdCBwcm9kdWN0cyA9IGF3YWl0IERhdGFiYXNlLnF1ZXJ5KCkuZnJvbSgncHJvZHVjdHMnKS5zZWxlY3QoJyonKS53aGVyZSgnY29kZScsIHBhcmFtcy5uYW1lKVxuICAgIHJldHVybiBwcm9kdWN0c1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHByb2R1Y3RzQnlDYXRlZ29yeSh7IHBhcmFtcyB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgLy9jcmVhdGUgYSBzZWxlY3Rpb24gb2YgcHJvZHVjdHMgd2hlcmUgbmFtZSBsaWtlICVwYXJhbXMubmFtZSVcbiAgICBjb25zdCBwcm9kdWN0cyA9IGF3YWl0IERhdGFiYXNlLnF1ZXJ5KCkuZnJvbSgncHJvZHVjdHMnKS5zZWxlY3QoJyonKS5vcmRlckJ5KHBhcmFtcy5jYXRlZ29yeSlcbiAgICBwcm9kdWN0cy5mb3JFYWNoKChwcm9kdWN0KSA9PiB7XG4gICAgICBpZiAocHJvZHVjdC5zdG9yYWdlID4gcHJvZHVjdC5tYXggKiAwLjIpIHtcbiAgICAgICAgcHJvZHVjdC5zdGF0dXMgPSAnR29vZCdcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHByb2R1Y3Quc3RhdHVzID0gJ0JhZCdcbiAgICAgIH1cbiAgICB9KVxuICAgIHJldHVybiBwcm9kdWN0c1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHVwZGF0ZSh7IHJlcXVlc3QsIHJlc3BvbnNlIH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICBjb25zdCB7XG4gICAgICBpZCxcbiAgICAgIGNvZGUsXG4gICAgICBzdXBsaWVyLFxuICAgICAgZGVzY3JpcHRpb24sXG4gICAgICBjbGFzczogcHJvZHVjdENsYXNzLFxuICAgICAgcHJpY2UsXG4gICAgICBzdG9yYWdlLFxuICAgICAgbWluLFxuICAgICAgbWF4LFxuICAgICAgcGxhY2UsXG4gICAgfSA9IGF3YWl0IHJlcXVlc3QudmFsaWRhdGUoVXBkYXRlVmFsaWRhdG9yKVxuICAgIGF3YWl0IERhdGFiYXNlLnRyYW5zYWN0aW9uKGFzeW5jICh0cngpID0+IHtcbiAgICAgIGNvbnN0IHByb2R1Y3QgPSBhd2FpdCBQcm9kdWN0LmZpbmRCeU9yRmFpbCgnaWQnLCBpZClcbiAgICAgIHByb2R1Y3QudXNlVHJhbnNhY3Rpb24odHJ4KVxuICAgICAgcHJvZHVjdC5tZXJnZSh7XG4gICAgICAgIGNvZGUsXG4gICAgICAgIHN1cGxpZXIsXG4gICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICBjbGFzczogcHJvZHVjdENsYXNzLFxuICAgICAgICBwcmljZSxcbiAgICAgICAgc3RvcmFnZSxcbiAgICAgICAgbWluLFxuICAgICAgICBtYXgsXG4gICAgICAgIHBsYWNlLFxuICAgICAgfSlcbiAgICAgIGF3YWl0IHByb2R1Y3Quc2F2ZSgpXG4gICAgICByZXR1cm4gcmVzcG9uc2Uub2soeyBtZXNzYWdlOiAnUHJvZHV0byBhbHRlcmFkbyBjb20gc3VjZXNzby4nIH0pXG4gICAgfSlcbiAgfVxuXG4gIC8vIHB1YmxpYyBhc3luYyBkZXN0cm95KHsgcmVxdWVzdCwgcmVzcG9uc2UsIGJvdW5jZXIgfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuICAvLyAgIGNvbnN0IHsgaWQgfSA9IGF3YWl0IHJlcXVlc3QudmFsaWRhdGUoRGVzdHJveVZhbGlkYXRvcilcbiAgLy8gICBjb25zdCBwcm9kdWN0ID0gYXdhaXQgUHJvZHVjdC5maW5kQnlPckZhaWwoJ2lkJywgaWQpXG4gIC8vICAgYXdhaXQgYm91bmNlci5hdXRob3JpemUoJ2lzQXV0aG9yaXplZCcsIHByb2R1Y3QudXNlcklkKVxuICAvLyAgIGF3YWl0IHByb2R1Y3QuZGVsZXRlKClcbiAgLy8gICByZXR1cm4gcmVzcG9uc2Uub2soeyBtZXNzYWdlOiAnUHJvZHV0byBkZWxldGFkbyBjb20gc3VjZXNzby4nIH0pXG4gIC8vIH1cbiAgLy8gLy9jcmVhdGUgYSBmdW5jdGlvbiB0byBnZXQgdGhlIHByb2R1Y3RzIGJ5IG5hbWVcbiAgLy8gcHVibGljIGFzeW5jIHByb2R1Y3RzQnlOYW1lKHsgcGFyYW1zIH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgLy8gICBjb25zdCBwcm9kdWN0cyA9IGF3YWl0IERhdGFiYXNlLnF1ZXJ5KClcbiAgLy8gICAgIC5mcm9tKCdwcm9kdWN0cycpXG4gIC8vICAgICAuc2VsZWN0KCcqJylcbiAgLy8gICAgIC53aGVyZSgnbmFtZScsICdsaWtlJywgYCUke3BhcmFtcy5uYW1lfSVgKVxuICAvLyAgICAgLm9yZGVyQnkoJ25hbWUnLCAnYXNjJylcbiAgLy8gICByZXR1cm4gcHJvZHVjdHNcbiAgLy8gfVxufVxuIl19